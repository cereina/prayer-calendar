<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Shia Prayer Times (Jafari) + Suhoor/Imsak</title>

    <!-- PrayTimes.js (supports Jafari / Ithna Ashari) -->
    <script src="https://praytimes.org/code/v2/js/PrayTimes.js"></script>

    <style>
        :root {
            --bg: #0b0f14;
            --card: #121826;
            --text: #e6e8ee;
            --muted: #9aa3b2;
            --line: #1f2a3a;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
            background: var(--bg);
            color: var(--text);
        }

        .wrap {
            max-width: 760px;
            margin: 0 auto;
            padding: 18px;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 14px;
        }

        h1 {
            margin: 0 0 6px 0;
            font-size: 20px;
        }

        .muted {
            color: var(--muted);
            font-size: 13px;
        }

        .grid {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr;
        }

        @media(min-width:720px) {
            .grid {
                grid-template-columns: 1.15fr 0.85fr;
            }
        }

        .row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--line);
        }

        .row:last-child {
            border-bottom: 0;
        }

        .pill {
            font-size: 12px;
            padding: 2px 8px;
            border: 1px solid var(--line);
            border-radius: 999px;
            color: var(--muted);
        }

        .hl {
            outline: 2px solid rgba(255, 255, 255, 0.14);
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 10px;
        }

        .controls {
            display: grid;
            gap: 10px;
        }

        label {
            font-size: 12px;
            color: var(--muted);
            display: block;
            margin-bottom: 4px;
        }

        input,
        select,
        button {
            width: 100%;
            background: #0f1522;
            color: var(--text);
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 10px 10px;
            font-size: 14px;
            box-sizing: border-box;
        }

        button {
            cursor: pointer;
        }

        .btnrow {
            display: flex;
            gap: 10px;
        }

        .btnrow button {
            width: 100%;
        }

        .big {
            font-size: 18px;
            font-weight: 700;
        }

        .count {
            font-size: 22px;
            font-weight: 800;
            margin-top: 6px;
        }

        .tiny {
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px;
        }

        .err {
            color: #ff9aa2;
            font-size: 13px;
            margin-top: 8px;
        }

        a {
            color: inherit;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="card" style="margin-bottom:12px;">
            <!--h1>Shia Prayer Times (Jafari) + Suhoor/Imsak</h1-->
            <h1>Prayers Times - Suhoor/Imsak</h1>
            <div class="muted" id="meta">Loading…</div>
        </div>

        <div class="grid">
            <div class="card">
                <div class="big" id="todayTitle">Today</div>
                <div class="tiny" id="hijriNote"></div>
                <div style="margin-top:10px;" id="timesList"></div>
            </div>

            <div class="card">
                <div class="big">Settings</div>
                <div class="controls" style="margin-top:10px;">
                    <div>
                        <label>Calculation Method</label>
                        <select id="method">
                            <option value="Jafari">Jafari (Ithna Ashari)</option>
                        </select>
                        <div class="tiny">Keep Jafari for Shia. Tehran exists in PrayTimes too.</div>
                    </div>

                    <div>
                        <label>Time Format</label>
                        <select id="timeFormat">
                            <option value="24h">24h</option>
                            <option value="12h">12h</option>
                        </select>
                    </div>

                    <div>
                        <label>Imsak (Suhoor stop) offset minutes before Fajr</label>
                        <input id="imsakOffset" type="number" min="0" max="90" step="1" />
                        <div class="tiny">Common values: 10–20 minutes.</div>
                    </div>

                    <div>
                        <label>Location</label>
                        <div class="btnrow">
                            <button id="btnGeo" type="button">Use GPS</button>
                            <button id="btnNow" type="button">Refresh</button>
                        </div>
                    </div>
                    <div>
                        <label>City</label>
                        <select id="citySelect">
                            <option value="">-- Select City --</option>
                            <option value="montreal">Montreal</option>
                            <option value="laval">Laval</option>
                            <option value="ottawa">Ottawa</option>
                            <option value="toronto">Toronto</option>
                        </select>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div>
                            <label>Latitude</label>
                            <input id="lat" type="number" step="0.000001" />
                        </div>
                        <div>
                            <label>Longitude</label>
                            <input id="lng" type="number" step="0.000001" />
                        </div>
                    </div>

                    <div>
                        <label>Timezone (hours from UTC)</label>
                        <input id="tz" type="number" step="0.5" />
                        <div class="tiny">Auto-filled from your device.</div>
                    </div>

                    <div class="err" id="error"></div>

                    <div style="margin-top:8px;">
                        <div class="pill" id="nextPill">Next: —</div>
                        <div class="count" id="countdown">—</div>
                        <div class="tiny" id="countdownNote"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="muted" style="margin-top:14px;">
            Tip: Save this file as <b>index.html</b> and open it in your browser. It stores settings locally.
        </div>
    </div>

    <script>
        // -----------------------
        // Local storage keys
        // -----------------------
        const KEY = "shia_prayer_app_v1";

        const cities = {
            montreal: { name: "Montreal", lat: 45.5017, lng: -73.5673, tz: -5 },
            laval: { name: "Laval", lat: 45.6066, lng: -73.7124, tz: -5 },
            ottawa: { name: "Ottawa", lat: 45.4215, lng: -75.6972, tz: -5 },
            toronto: { name: "Toronto", lat: 43.6532, lng: -79.3832, tz: -5 }
        };
        // -----------------------
        // Helpers
        // -----------------------
        function pad2(n) { return String(n).padStart(2, "0"); }

        function getLocalTzHours() {
            const now = new Date();
            return -now.getTimezoneOffset() / 60;
        }

        function parseHHMM(hhmm) {
            // supports "HH:MM" or "H:MM" (and PrayTimes 12h outputs like "5:12 am")
            // We'll normalize by extracting digits and optional am/pm.
            const s = hhmm.trim().toLowerCase();
            const ampm = s.includes("pm") ? "pm" : (s.includes("am") ? "am" : null);
            const m = s.match(/(\d{1,2})\s*:\s*(\d{2})/);
            if (!m) return null;
            let hh = Number(m[1]), mm = Number(m[2]);
            if (ampm) {
                if (ampm === "pm" && hh !== 12) hh += 12;
                if (ampm === "am" && hh === 12) hh = 0;
            }
            return { hh, mm };
        }

        function minutesSinceMidnight(hhmm) {
            const t = parseHHMM(hhmm);
            if (!t) return null;
            return t.hh * 60 + t.mm;
        }

        function formatFromMinutes(total, fmt) {
            total = (total % 1440 + 1440) % 1440;
            const hh24 = Math.floor(total / 60);
            const mm = total % 60;
            if (fmt === "24h") return `${pad2(hh24)}:${pad2(mm)}`;
            // 12h
            const ampm = hh24 >= 12 ? "pm" : "am";
            let hh12 = hh24 % 12; if (hh12 === 0) hh12 = 12;
            return `${hh12}:${pad2(mm)} ${ampm}`;
        }

        function minusMinutes(hhmm, mins, fmt) {
            const base = minutesSinceMidnight(hhmm);
            if (base == null) return "—";
            return formatFromMinutes(base - mins, fmt);
        }

        function safeNum(v, fallback) {
            const n = Number(v);
            return Number.isFinite(n) ? n : fallback;
        }

        function saveState(state) {
            localStorage.setItem(KEY, JSON.stringify(state));
        }

        function loadState() {
            try {
                const raw = localStorage.getItem(KEY);
                if (!raw) return null;
                return JSON.parse(raw);
            } catch {
                return null;
            }
        }

        function toDateKey(d) {
            return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
        }

        // -----------------------
        // Optional Hijri date (simple Intl, varies by browser/locale)
        // -----------------------
        function getHijriString(date = new Date()) {
            try {
                const fmt = new Intl.DateTimeFormat("en-u-ca-islamic", {
                    day: "numeric", month: "long", year: "numeric"
                });
                return fmt.format(date);
            } catch {
                return "";
            }
        }

        // -----------------------
        // Core Prayer Calculation + Rendering
        // -----------------------
        let countdownTimer = null;
        let lastComputed = null; // store schedule for countdown

        function computeAndRender() {
            const errorEl = document.getElementById("error");
            errorEl.textContent = "";

            const method = document.getElementById("method").value;
            const timeFormat = document.getElementById("timeFormat").value;

            const lat = safeNum(document.getElementById("lat").value, null);
            const lng = safeNum(document.getElementById("lng").value, null);
            const tz = safeNum(document.getElementById("tz").value, getLocalTzHours());
            const imsakOffset = Math.max(0, Math.min(90, safeNum(document.getElementById("imsakOffset").value, 20)));

            if (lat == null || lng == null) {
                errorEl.textContent = "Please set Latitude and Longitude (or click Use GPS).";
                return;
            }

            // PrayTimes instance
            const pt = new PrayTimes(method);

            // Compute today's times
            const today = new Date();
            const times = pt.getTimes(today, [lat, lng], tz, 0, timeFormat);

            // Derive Shia fasting helpers
            const fajr = times.fajr;
            const imsak = minusMinutes(fajr, imsakOffset, timeFormat);
            const suhoorEnd = fajr; // fast starts at fajr

            // Build list order (include imsak/suhoor)
            const rows = [
                { key: "imsak", label: "Imsak (stop eating)", value: imsak, type: "fasting" },
                { key: "fajr", label: "Fajr (fast begins)", value: fajr, type: "prayer" },
                { key: "sunrise", label: "Sunrise", value: times.sunrise, type: "sun" },
                { key: "dhuhr", label: "Dhuhr", value: times.dhuhr, type: "prayer" },
                { key: "asr", label: "Asr", value: times.asr, type: "prayer" },
                { key: "maghrib", label: "Maghrib (Iftar)", value: times.maghrib, type: "prayer" },
                { key: "isha", label: "Isha", value: times.isha, type: "prayer" },
            ];

            // Render header/meta
            const meta = document.getElementById("meta");
            const dateStr = today.toLocaleDateString(undefined, { weekday: "long", year: "numeric", month: "long", day: "numeric" });
            meta.textContent = `${dateStr} • Method: ${method} • Lat ${lat.toFixed(4)}, Lng ${lng.toFixed(4)} • TZ ${tz}`;

            const hijri = getHijriString(today);
            document.getElementById("hijriNote").textContent = hijri ? `Hijri (approx): ${hijri}` : "";

            // Determine "current/next" event for highlighting
            const nowMin = today.getHours() * 60 + today.getMinutes();

            // Create "schedule" items with minutes (today), and also compute next-day fajr for after-isha case
            const schedule = rows.map(r => ({
                ...r,
                minutes: minutesSinceMidnight(r.value)
            })).filter(r => r.minutes != null);

            // For next event, find first item with minutes > nowMin
            let next = schedule.find(x => x.minutes > nowMin);
            let nextInMinutes = null;

            if (!next) {
                // next is tomorrow's Imsak (or Fajr). We'll compute tomorrow times.
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);
                const t2 = pt.getTimes(tomorrow, [lat, lng], tz, 0, timeFormat);
                const fajr2 = t2.fajr;
                const imsak2 = minusMinutes(fajr2, imsakOffset, timeFormat);
                // next event: imsak tomorrow
                next = { key: "imsak", label: "Imsak (stop eating)", value: imsak2, minutes: minutesSinceMidnight(imsak2), dayOffset: 1 };
                nextInMinutes = (1440 - nowMin) + next.minutes;
            } else {
                nextInMinutes = next.minutes - nowMin;
                next.dayOffset = 0;
            }

            // Highlight current row: last event whose time <= now (today only)
            // (If it's after Isha, current becomes Isha.)
            let current = null;
            for (const item of schedule) {
                if (item.minutes <= nowMin) current = item;
            }
            if (!current) current = schedule[0];

            // Render list with highlight
            const list = document.getElementById("timesList");
            list.innerHTML = rows.map(r => {
                const mins = minutesSinceMidnight(r.value);
                const isCurrent = (current && r.key === current.key);
                const badge = r.key === "imsak" ? "FAST" : (r.key === "maghrib" ? "IFTAR" : "");
                return `
            <div class="${isCurrent ? "hl" : ""}">
              <div class="row">
                <div>
                  <div>${r.label}</div>
                  ${badge ? `<div class="tiny">${badge}</div>` : ``}
                </div>
                <div style="font-weight:700;">${r.value}</div>
              </div>
            </div>
          `;
            }).join("");

            // Save for countdown loop
            lastComputed = {
                method, timeFormat, lat, lng, tz, imsakOffset,
                todayKey: toDateKey(today),
                next: { ...next, nextInMinutes },
            };

            // Start/refresh countdown
            startCountdown();
            persistInputs();
        }

        function persistInputs() {
            const state = {
                method: document.getElementById("method").value,
                timeFormat: document.getElementById("timeFormat").value,
                imsakOffset: safeNum(document.getElementById("imsakOffset").value, 20),
                lat: safeNum(document.getElementById("lat").value, null),
                lng: safeNum(document.getElementById("lng").value, null),
                tz: safeNum(document.getElementById("tz").value, getLocalTzHours()),
            };
            saveState(state);
        }

        function hydrateInputs() {
            const st = loadState();
            document.getElementById("tz").value = getLocalTzHours();

            if (st) {
                if (st.method) document.getElementById("method").value = st.method;
                if (st.timeFormat) document.getElementById("timeFormat").value = st.timeFormat;
                document.getElementById("imsakOffset").value = safeNum(st.imsakOffset, 20);
                if (Number.isFinite(st.lat)) document.getElementById("lat").value = st.lat;
                if (Number.isFinite(st.lng)) document.getElementById("lng").value = st.lng;
                if (Number.isFinite(st.tz)) document.getElementById("tz").value = st.tz;
            } else {
                document.getElementById("imsakOffset").value = 20;
            }
        }

        function startCountdown() {
            if (countdownTimer) clearInterval(countdownTimer);

            function tick() {
                const nextPill = document.getElementById("nextPill");
                const countdown = document.getElementById("countdown");
                const note = document.getElementById("countdownNote");

                if (!lastComputed) {
                    nextPill.textContent = "Next: —";
                    countdown.textContent = "—";
                    note.textContent = "";
                    return;
                }

                const now = new Date();
                // if day changed, recompute
                if (toDateKey(now) !== lastComputed.todayKey) {
                    computeAndRender();
                    return;
                }

                // Compute remaining seconds to next event:
                // Use nextInMinutes (computed at render time) then subtract elapsed since last minute boundary.
                // We'll compute precisely: find "target time" based on next value and dayOffset.
                const t = parseHHMM(lastComputed.next.value);
                if (!t) return;

                const target = new Date(now);
                if (lastComputed.next.dayOffset === 1) {
                    target.setDate(target.getDate() + 1);
                }
                target.setHours(t.hh, t.mm, 0, 0);

                let diffMs = target - now;
                if (diffMs < 0) diffMs = 0;

                const totalSec = Math.floor(diffMs / 1000);
                const hh = Math.floor(totalSec / 3600);
                const mm = Math.floor((totalSec % 3600) / 60);
                const ss = totalSec % 60;

                nextPill.textContent = `Next: ${lastComputed.next.label} • ${lastComputed.next.value}`;
                countdown.textContent = `${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;
                note.textContent = `Method: ${lastComputed.method} • Imsak offset: ${lastComputed.imsakOffset} min`;
            }

            tick();
            countdownTimer = setInterval(tick, 1000);
        }

        // -----------------------
        // GPS
        // -----------------------
        function useGPS() {
            const errorEl = document.getElementById("error");
            errorEl.textContent = "";
            if (!navigator.geolocation) {
                errorEl.textContent = "Geolocation not supported by your browser.";
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    document.getElementById("lat").value = pos.coords.latitude.toFixed(6);
                    document.getElementById("lng").value = pos.coords.longitude.toFixed(6);
                    document.getElementById("tz").value = getLocalTzHours();
                    computeAndRender();
                },
                (err) => {
                    errorEl.textContent = "GPS blocked or unavailable. Enter lat/lng manually.";
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        // -----------------------
        // Auto-Fill Lat/Lng When City Changes
        // -----------------------


        document.getElementById("citySelect").addEventListener("change", function () {
            const selected = this.value;

            if (!selected || !cities[selected]) return;

            const city = cities[selected];

            document.getElementById("lat").value = city.lat;
            document.getElementById("lng").value = city.lng;
            document.getElementById("tz").value = getLocalTzHours();

            computeAndRender();
        });

        // -----------------------
        // Wire up events
        // -----------------------
        hydrateInputs();

        document.getElementById("btnGeo").addEventListener("click", useGPS);
        document.getElementById("btnNow").addEventListener("click", computeAndRender);

        ["method", "timeFormat", "imsakOffset", "lat", "lng", "tz"].forEach(id => {
            document.getElementById(id).addEventListener("change", computeAndRender);
        });

        // Initial render
        // If no saved lat/lng, it will ask to use GPS or manual input.
        computeAndRender();
    </script>
</body>

</html>